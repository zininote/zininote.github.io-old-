---
layout: post
title: "VLOOKUP: 유사일치 방식으로 VLOOKUP 함수 속도 높이기"
updated: 2021-05-03
tags: [msoffice,formula]
---

## VLOOKUP 검색 속도 문제

VLOOKUP 함수의 일반적인 사용법은 아래와 같다.

```excel
= VLOOKUP( 검색값, 검색범위, 열번호, 작동방식 )
```
{:.excel}

특히 네번째 `작동방식` 인수에는 옵션값을 넣는데, 보통은 0 또는 FALSE 값을 사용하여 `검색값`이 "정확히일치" 하도록한다.

편리한 함수이기는 하지만, 사용하는 VLOOKUP 함수 개수나 `검색범위`가 상당히 많아진다면, 누구나 한번쯤은 갑자기 느려진 계산속도를 경험해 봤을 것이다. 하지만 느린 VLOOKUP 속도를 매우 빠르게 개선할 수 있는 방법이 있다.

## 속도개선 VLOOKUP 함수식

![그림00](/img/msoffice/formula/formula-0000.png)

```excel
= IF( 검색값=VLOOKUP( 검색값, 검색범위, 1, TRUE ), VLOOKUP( 검색값, 검색범위, 열번호, TRUE ), NA())
```
{:.excel}

위 함수식을 보면 `작동방식`에 TRUE 값을 지정하여 "정확히일치"가 아닌 "유사일치" 옵션을 사용하면서, VLOOKUP 함수를 두번 사용했다.

위 함수식이 제대로 작동하려면, 검색기준열에 해당되는 **`검색범위`의 가장 왼쪽열은 반드시 오름차순으로 정렬**이 되어있어야 한다. (그 이유에 대해서는 보다 아래에 나와있다.) 따라서, `검색범위`에 새로운 데이터를 갱신 할 때마다 다시금 정렬을 해줘야 한다.

다소 불편할지 모르지만, VLOOKUP 검색 속도를 체험하고 나면 충분히 감수할만한 불편함이라고 느끼게 될 것이다. 그만큼 속도가 매우 빠르다.

## 함수식 이해

VLOOKUP 에서 "정확히일치" 옵션을 사용하면, `검색범위`의 가장 위 데이터부터 순서대로 `검색값`과 정확하게 일치하는 데이터를 찾는다. 만일 10,000 개의 데이터가 있다고 하면, 최악의 경우 10,000 번 비교검색을 하게 되는 셈이다.

하지만 "유사일치" 옵션이라면 최악의 경우라도 15 번만 비교검색 하면 된다. 매우 놀라운데 이유를 따져보자. 10,000 개의 데이터가 오름차순으로 정렬되어 있을 때, 먼저 중간에 위치한 데이터값과 `검색값`을 비교한다. 만일 `중간데이터값 < 검색값` 이라면 중간데이터의 앞부분은 이제 검색할 필요가 없다. 왜냐하면 앞부분들은 모두 중간데이터값보다는 작은 값들이라 당연히 `검색값` 보다도 작을 것이 확실하기 때문이다. 단 한번의 비교검색 만으로 이제 남은 데이터 수는 5,000 개가 된다. 남은 5,000 개 중의 중간데이터값과 `검색값`을 다시 비교한다. `중간데이터값 > 검색값` 이라면, 이제 중간데이터값 이후를 버린다. 이제 2,500 개 데이터만 남았다. ... 이런 식으로 계속 비교해나가면 최악의 경우라고 해봤자 15 번만 검색하게 됨을 알 수 있다.

이와 같은 검색 알고리즘을 [이진탐색](https://namu.wiki/w/%EC%9D%B4%EC%A7%84%20%ED%83%90%EC%83%89)이라고 한다. [별도 포스팅](/post/binary-search)에도 소개하였으니 Python 프로그래밍에 관심이 있다면 참고해보기 바란다.

이진탐색이라는 방식을 사용하기에 속도가 매우 빠른 것이다. 그리고 이 방식을 적용하기 위해서는 왜 오름차순 정렬이 필요한지도 알 수 있을 것이다.

그리고 본래 "유사일치" 방식으로 VLOOKUP 함수를 사용하면, `검색값` 을 찾지 못했을 때는 그와 가장 유사한 값을 찾아낸다. `검색값`이 없다면 에러를 발생시키도록, IF 와 NA 함수로 "정확히일치" 방식과 동일하게 작동하도록 한 것이다.